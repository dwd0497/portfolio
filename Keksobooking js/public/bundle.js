(()=>{"use strict";const e="GET",t="POST",o="https://21.javascript.pages.academy/keksobooking/data",n="https://21.javascript.pages.academy/keksobooking",r="Произошла ошибка соединения.",s="Запрос не успел выполниться за",a="мс",c={400:"Неверный запрос. Ошибка 400.",401:"Пользователь не авторизован. Ошибка 401.",404:"Информация не найдена. Ошибка 404.",500:"Ошибка сервера. Ошибка 500."},u=(t,o,n,u=e,i=null)=>{const l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",(()=>{200===l.status?o(l.response):n(c[l.status])})),l.addEventListener("error",(function(){n(r)})),l.addEventListener("timeout",(function(){n(`${s} ${l.timeout} ${a}`)})),l.timeout=1e4,l.open(u,t),l.send(i)},i=(e,t)=>{const o=e[t]?e[t]:new Set;return e[t]=o,o},l=function(e,t){i(this.listeners,e).add(t)},d=function(e,t){i(this.listeners,e).delete(t)},p=function(e,...t){i(this.listeners,e).forEach((e=>{e(...t)}))},m=()=>({listeners:{},on:l,off:d,emit:p}),f=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}};function y(e){return"Enter"===e.key}function h(e){return"Escape"===e.key}const v=(e,t,o,n=null)=>{const r=document.createDocumentFragment();let s=[];return n&&(e=e.slice(0,n)),e.forEach(((e,t)=>{const n=o(e,t);r.appendChild(n),s.push(n)})),t.appendChild(r),s},g=(e,t,o)=>{_(t),((e,t,o)=>{const n=document.createDocumentFragment();e.forEach(((e,t)=>{n.appendChild(o(e,t))})),t.appendChild(n)})(e,t,o)},_=e=>{for(;e.firstChild;)e.firstChild.remove()},S=(e,t)=>Array.prototype.forEach.call(e,t),q=["gif","jpg","jpeg","png"],L=e=>"IMG"!==e.tagName,E=(e,t)=>{e.src=t},x=e=>{L(e)?_(e):E(e,"img/muffin-grey.svg")},k=e=>t=>{x(e);const o=document.createDocumentFragment(),n=t.target;let r=0;S(n.files,(t=>{const s=t.name.toLowerCase();if(!q.some((e=>s.endsWith(e))))return;const a=new FileReader;a.addEventListener("load",(()=>{r++,L(e)?((e,t,o,n,r)=>{const s=document.createElement("img");s.src=e,t.appendChild(s),n===r&&o.appendChild(t)})(a.result,o,e,r,n.files.length):E(e,a.result)})),a.readAsDataURL(t)}))},C=document.querySelector("#error").content.querySelector(".error"),w=(e,t)=>{const o=C.cloneNode(!0),n=o.querySelector(".error__message"),r=o.querySelector(".error__button");n.textContent=e,t.appendChild(o),o.addEventListener("click",b(o)),r.addEventListener("click",$(o)),document.addEventListener("keydown",M(o))},b=e=>()=>{e.remove()},M=e=>t=>{h(t)&&(document.removeEventListener("keydown",M(e)),e.remove())},$=e=>()=>{e.remove()},j="100 комнат не для гостей",D="Не для гостей только 100 комнатные номера",V="Количество мест не может превышать количество комнат",N=document.querySelector("main"),T=document.querySelector(".ad-form"),F=T.querySelector("#address"),R=T.querySelector("#capacity"),I=T.querySelector("#room_number"),A=T.querySelector("#type"),H=T.querySelector("#price"),W=T.querySelector("#timein"),X=T.querySelector("#timeout"),B=document.querySelector(".map__filters"),G=document.querySelector(".ad-form__reset"),O=document.querySelector("#success").content.querySelector(".success"),Y=document.querySelector("#avatar"),P=document.querySelector(".ad-form-header__preview img"),U=document.querySelector("#images"),z=document.querySelector(".ad-form__photo"),J=m(),K={bungalow:0,flat:1e3,house:5e3,palace:1e4},Q=k(P),Z=k(z),ee=(e,t)=>{S(e,(function(e){e.disabled=t,e.parentElement.classList.contains("map__filters")&&t?e.classList.add("hidden"):e.classList.remove("hidden")}))};ee(T.children,!0),ee(B.children,!0);const te=(e,t,o)=>{100===e&&0!==t?o.setCustomValidity(j):e<t&&0!==t?o.setCustomValidity(V):100!==e&&0===t?o.setCustomValidity(D):o.setCustomValidity(""),o.reportValidity()},oe=()=>{const e=+R.value,t=+I.value;te(t,e,R)},ne=()=>{const e=+R.value,t=+I.value;te(t,e,R)},re=()=>{se()},se=()=>{H.min=K[A.value],H.placeholder=K[A.value]},ae=()=>{X.value=W.value},ce=()=>{W.value=X.value},ue=e=>{e.preventDefault();const o=+R.value,r=+I.value;te(r,o,R),R.checkValidity()&&I.checkValidity()&&((e,o,r)=>{u(n,e,o,t,r)})(ie,le,new FormData(T))},ie=()=>{(()=>{const e=O.cloneNode(!0);var t;T.appendChild(e),e.addEventListener("click",(t=e,()=>{t.remove()})),document.addEventListener("keydown",(e=>{const t=o=>{h(o)&&(document.removeEventListener("keydown",t),e.remove())};return t})(e))})(),pe(),T.reset(),se()},le=e=>{w(e,N)},de=e=>{const t=e?"addEventListener":"removeEventListener";R[t]("change",oe),I[t]("change",ne),A[t]("change",re),W[t]("change",ae),X[t]("change",ce),T[t]("submit",ue)},pe=()=>{T.classList.add("ad-form--disabled"),ee(T.children,!0),ee(B.children,!0),de(!1),G.removeEventListener("click",me),Y.removeEventListener("change",Q),U.removeEventListener("change",Z),x(P),x(z),J.emit("deactivate")},me=e=>{e.preventDefault(),T.reset(),pe()},fe=m(),ye=(e,t,o)=>({x:Math.floor(e.x+t),y:Math.floor(e.y+o)}),he="570px",ve="375px",ge=22,_e=document.querySelector(".map__pin--main"),Se=m(),qe=()=>_e.offsetHeight,Le=e=>{(function(e){return 0===e.button})(e)&&(Se.emit("activate"),((e,t,o)=>{const n=t.getBoundingClientRect(),r=t.parentNode.getBoundingClientRect(),s={x:e.clientX-n.x,y:e.clientY-n.y},a=t.offsetWidth/2,c=t.offsetHeight+o,u=e=>{let o=((e,t)=>({x:e.x-t.x,y:e.y-t.y}))({x:e.clientX-r.x,y:e.clientY-r.y},s);const n=ye(o,a,c);n.x=Math.max(n.x,0),n.x=Math.min(n.x,1200),n.y=Math.max(n.y,130),n.y=Math.min(n.y,630),((e,{x:t,y:o})=>{e.style.left=t+"px",e.style.top=o+"px"})(t,((e,t,o)=>ye(e,-t,-o))(n,a,c)),fe.emit("move")},i=()=>{document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",u),document.addEventListener("mouseup",i)})(e,_e,ge))},Ee=e=>{y(e)&&Se.emit("activate")};(e=>{const t="addEventListener";_e[t]("mousedown",Le),_e[t]("keydown",Ee)})();const xe=document.querySelector(".map__filters-container"),ke=document.querySelector("#card").content.querySelector(".map__card"),Ce={flat:"Квартира",bungalow:"Бунгало",palace:"Дворец",house:"Дом"};let we=null,be=null;const Me=(e,t,o)=>e?o(t):t.remove(),$e=e=>{const t=document.createElement("li");return t.classList.add("popup__feature","popup__feature--"+e),t},je=e=>{const t=document.createElement("img");return t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=""+e,t},De=e=>{h(e)&&(Te(!1,be),Ne(),we())},Ve=()=>{Te(!1,be),Ne(),we()},Ne=()=>{be&&be.remove()},Te=(e,t)=>{const o=e?"addEventListener":"removeEventListener",n=t.querySelector(".popup__close");n&&(n[o]("click",Ve),document[o]("keydown",De))},Fe=(e,t)=>{we=t,Ne(),be=(e=>{const t=(e=>{const t=ke.cloneNode(!0);return Me(e.offer.title,t.querySelector(".popup__title"),(t=>{t.textContent=e.offer.title})),Me(e.offer.address,t.querySelector(".popup__text--address"),(t=>{t.textContent=e.offer.address})),Me(e.offer.price,t.querySelector(".popup__text--price"),(t=>{t.textContent=e.offer.price+"₽/ночь"})),Me(e.offer.type,t.querySelector(".popup__type"),(t=>{t.textContent=Ce[e.offer.type]})),Me(e.offer.rooms&&e.offer.guests,t.querySelector(".popup__text--capacity"),(t=>{t.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`})),Me(e.offer.checkin&&e.offer.checkout,t.querySelector(".popup__text--time"),(t=>{t.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`})),Me(e.offer.description,t.querySelector(".popup__description"),(t=>{t.textContent=e.offer.description})),Me(e.author.avatar,t.querySelector(".popup__avatar"),(t=>{t.src=e.author.avatar})),g(e.offer.photos,t.querySelector(".popup__photos"),je),g(e.offer.features,t.querySelector(".popup__features"),$e),t})(e);return xe.insertAdjacentElement("afterend",t),Te(!0,t),t})(e)},Re=50,Ie=70,Ae="map__pin--secondary",He="map__pin--active",We=5,Xe=document.querySelector(".map__pins"),Be=document.querySelector("#pin").content.querySelector(".map__pin");let Ge=null,Oe=null,Ye=null,Pe=null;const Ue=(e,t)=>{const o=Be.cloneNode(!0);o.classList.add(Ae),((e,t)=>{e.style.top=t.y-Ie+"px",e.style.left=t.x-Re/2+"px"})(o,e.location);const n=o.querySelector("img");return n.src=""+e.author.avatar,n.alt=""+e.offer.title,o.value=t,o.addEventListener("click",Ke),o.addEventListener("keydown",Qe),o},ze=()=>{null!==Ge&&Ge!==[]&&Ge.forEach((e=>e.remove()))},Je=()=>{Pe&&Pe.classList.remove(He)},Ke=e=>{Je();const t=e.currentTarget;Pe=t,t.classList.add(He),Fe(Ye?Ye[t.value]:Oe[t.value],Je)},Qe=e=>{y(e)&&Ke(e)},Ze=e=>{ze(),Ne(),Ye=e(Oe,We),Ge=v(Ye,Xe,Ue)},et=document.querySelector(".map__filters"),tt=et.querySelector("#housing-type"),ot=et.querySelector("#housing-price"),nt=et.querySelector("#housing-rooms"),rt=et.querySelector("#housing-guests"),st=et.querySelector("#housing-features"),at=new Set,ct={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"},ut=function(e){return"any"===e},it=(e,t)=>((e,t,o)=>{const n=[];for(let r=0;r<e.length&&n.length!==o;r++){const o=e[r];t(o)&&n.push(o)}return n})(e,(e=>{return e.offer&&(o=e.offer.type,n=ct["housing-type"],ut(n)||o===n)&&((e,t)=>ut(t)||"low"===t&&e<1e4||"middle"===t&&e>=1e4&&e<=5e4||"high"===t&&e>5e4)(e.offer.price,ct["housing-price"])&&((e,t)=>ut(t)||e===+t)(e.offer.rooms,ct["housing-rooms"])&&((e,t)=>ut(t)||e===+t)(e.offer.guests,ct["housing-guests"])&&(t=e.offer.features,[...at].every((e=>t.includes(e.value))));var t,o,n}),t),lt=f((e=>{ct[e.target.name]=e.target.value,Ze(it)})),dt=f((e=>{at.has(e.target)?at.delete(e.target):at.add(e.target),Ze(it)})),pt=e=>{const t=e?"addEventListener":"removeEventListener";tt[t]("change",lt),ot[t]("change",lt),nt[t]("change",lt),rt[t]("change",lt),st[t]("change",dt)},mt=document.querySelector(".map");J.on("deactivate",(()=>{ft(),yt()})),Se.on("activate",(()=>{ht()})),fe.on("move",(()=>{yt()}));const ft=()=>{mt.classList.add("map--faded"),ze(),Ne(),pt(!1),Object.assign(ct,{"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"}),at.clear(),et.reset(),_e.style.top=ve,_e.style.left=he},yt=()=>{return e=Math.round(parseInt(_e.style.left,10)+_e.offsetWidth/2),t=mt.classList.contains("map--faded")?Math.round(parseInt(_e.style.top,10)+qe()/2):Math.round(parseInt(_e.style.top,10)+qe()+ge),void(F.value=`${e}, ${t}`);var e,t},ht=()=>{mt.classList.contains("map--faded")&&(((e,t)=>{u(o,e,t)})(vt,gt),yt())},vt=e=>{(e=>{mt.classList.remove("map--faded"),Oe=e,ze(),Ge=v(Oe,Xe,Ue,We),T.classList.remove("ad-form--disabled"),ee(T.children,!1),ee(B.children,!1),de(!0),G.addEventListener("click",me),Y.addEventListener("change",Q),U.addEventListener("change",Z),pt(!0)})(e)},gt=e=>{w(e,mt)};yt()})();